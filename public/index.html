<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Knight‚Äôs Tour - B√∫squeda Continua sin l√≠mite</title>
<style>
  body { font-family: Arial, sans-serif; padding: 1rem; background: #f9f9f9; }
  button { margin: 0.3rem; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; }
  pre { background: #eee; padding: 1rem; max-height: 200px; overflow: auto; }
</style>
</head>
<body>

<h1>Knight‚Äôs Tour - B√∫squeda Continua sin l√≠mite</h1>

<label for="boardSize">Tama√±o tablero (recomendado 5 para rendimiento): </label>
<input type="number" id="boardSize" min="5" max="8" value="5" />

<br /><br />

<button id="btnStart">üîÅ Iniciar b√∫squeda sin fin (segura)</button>
<button id="btnStop" disabled>‚èπÔ∏è Detener y exportar cat√°logo</button>

<pre id="progressInfo">Esperando inicio...</pre>

<script>
  const knightMoves = [
    [2, 1], [1, 2], [-1, 2], [-2, 1],
    [-2, -1], [-1, -2], [1, -2], [2, -1]
  ];

  let safeRunning = false;
  let safeCatalog = [];
  let seenKeys = new Set();
  let startX = 0, startY = 0;
  let boardSize = 5;

  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const progressInfo = document.getElementById('progressInfo');

  btnStart.onclick = () => {
    boardSize = parseInt(document.getElementById('boardSize').value);
    if (boardSize < 5 || boardSize > 8) {
      alert('Usa un tama√±o entre 5 y 8 para rendimiento y viabilidad.');
      return;
    }
    safeRunning = true;
    safeCatalog = [];
    seenKeys = new Set();
    startX = 0;
    startY = 0;
    btnStart.disabled = true;
    btnStop.disabled = false;
    progressInfo.textContent = 'üîÑ Iniciando b√∫squeda...';
    scheduleNextSearch();
  };

  btnStop.onclick = () => {
    safeRunning = false;
    btnStop.disabled = true;
    btnStart.disabled = false;
    progressInfo.textContent += "\n‚èπÔ∏è B√∫squeda detenida. Preparando exportaci√≥n...";
    exportCatalog();
  };

  function scheduleNextSearch() {
    if (!safeRunning) return;

    if (startY >= boardSize) {
      safeRunning = false;
      btnStop.disabled = true;
      btnStart.disabled = false;
      progressInfo.textContent += "\n‚úÖ B√∫squeda terminada.";
      exportCatalog();
      return;
    }

    setTimeout(async () => {
      const x = startX;
      const y = startY;
      await processSingleStart(x, y);
      startX++;
      if (startX >= boardSize) {
        startX = 0;
        startY++;
      }
      scheduleNextSearch();
    }, 50);
  }

  async function processSingleStart(x, y) {
    const board = Array.from({ length: boardSize }, () => Array(boardSize).fill(-1));
    const path = [];
    const result = await fullBacktrack(x, y, 0, path, board, boardSize);

    if (result) {
      const key = result.map(p => p.join(',')).join(';');
      if (!seenKeys.has(key)) {
        seenKeys.add(key);
        const name = `${result[0][0]}${result[0][1]}_${result[1][0]}${result[1][1]}_${result.at(-1)[0]}${result.at(-1)[1]}_${safeCatalog.length + 1}`;
        safeCatalog.push({ name, path: result });
      }

      // derivadas
      const derivadas = findDerivadas(result, boardSize);
      for (const d of derivadas) {
        const dKey = d.map(p => p.join(',')).join(';');
        if (!seenKeys.has(dKey)) {
          seenKeys.add(dKey);
          const dName = `${d[0][0]}${d[0][1]}_${d[1][0]}${d[1][1]}_${d.at(-1)[0]}${d.at(-1)[1]}_${safeCatalog.length + 1}`;
          safeCatalog.push({ name: dName, path: d });
        }
      }
    }

    progressInfo.textContent = `Procesando: (${x},${y}) ‚Üí Cat√°logo: ${safeCatalog.length} recorridos √∫nicos`;
  }

  async function fullBacktrack(x, y, moveNum, path, board, N) {
    board[y][x] = moveNum;
    path.push([x, y]);

    if (moveNum === N * N - 1) return [...path];

    for (const [dx, dy] of knightMoves) {
      const nx = x + dx;
      const ny = y + dy;
      if (nx >= 0 && ny >= 0 && nx < N && ny < N && board[ny][nx] === -1) {
        const res = await fullBacktrack(nx, ny, moveNum + 1, path, board, N);
        if (res) return res;
      }
    }

    board[y][x] = -1;
    path.pop();
    return null;
  }

  function findDerivadas(originalPath, N) {
    const derivadas = [];

    for (let i = originalPath.length - 2; i >= 5; i--) {
      const partial = originalPath.slice(0, i);
      const board = Array.from({ length: N }, () => Array(N).fill(-1));
      let moveNum = 0;

      for (const [x, y] of partial) {
        board[y][x] = moveNum++;
      }

      const [lastX, lastY] = partial[partial.length - 1];
      const path = [...partial];

      const res = backtrackFrom(lastX, lastY, moveNum, board, path);
      if (res && res.length === N * N) {
        derivadas.push(res);
      }
    }

    return derivadas;
  }

  function backtrackFrom(x, y, moveNum, board, path) {
    if (moveNum === board.length * board.length) return path;

    for (const [dx, dy] of knightMoves) {
      const nx = x + dx;
      const ny = y + dy;
      if (nx >= 0 && ny >= 0 && nx < board.length && ny < board.length && board[ny][nx] === -1) {
        board[ny][nx] = moveNum;
        path.push([nx, ny]);
        const res = backtrackFrom(nx, ny, moveNum + 1, board, path);
        if (res) return res;
        path.pop();
        board[ny][nx] = -1;
      }
    }

    return null;
  }

  function exportCatalog() {
    if (safeCatalog.length === 0) {
      alert('No hay soluciones para exportar.');
      return;
    }
    const blob = new Blob([JSON.stringify(safeCatalog, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `catalogo_knight_${boardSize}x${boardSize}.json`;
    a.click();
    URL.revokeObjectURL(url);
    progressInfo.textContent += "\n‚úÖ Exportaci√≥n lista.";
  }
</script>

</body>
</html>
